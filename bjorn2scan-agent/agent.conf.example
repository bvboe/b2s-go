# Bjorn2Scan Agent Configuration File
# Copy this file to /etc/bjorn2scan/agent.conf or ./agent.conf
# Environment variables override values in this file

# Server port (default: 9999)
# Environment variable: PORT
port=9999

# Database path (default: /var/lib/bjorn2scan/data/containers.db)
# Environment variable: DB_PATH
db_path=/var/lib/bjorn2scan/data/containers.db

# Enable debug mode (default: false)
# When enabled, adds /debug/sql and /debug/metrics endpoints
# WARNING: Only enable in development/testing - NOT for production
# Environment variable: DEBUG_ENABLED
debug_enabled=false

# ============================================================================
# AUTO-UPDATE CONFIGURATION
# ============================================================================

# Enable automatic updates (default: true)
# When enabled, agent will periodically check for new versions and auto-update
auto_update_enabled=true

# Update check interval (default: 6h)
# Format: Go duration string (e.g., "6h", "24h", "30m")
auto_update_check_interval=1h

# Allow automatic minor version updates (default: true)
# Example: 0.1.x → 0.2.x
auto_update_minor_versions=true

# Allow automatic major version updates (default: false)
# Example: 0.x.x → 1.x.x
auto_update_major_versions=false

# Pin to a specific version (default: empty = auto-update)
# When set, only this version will be installed
# Example: auto_update_pinned_version=0.1.35
auto_update_pinned_version=

# Minimum allowed version (default: empty = no minimum)
# Will not downgrade below this version
auto_update_min_version=

# Maximum allowed version (default: empty = no maximum)
# Will not upgrade above this version
auto_update_max_version=

# Release feed URL (default: https://github.com/bvboe/b2s-go/releases.atom)
# Atom/RSS feed containing release information
update_feed_url=https://github.com/bvboe/b2s-go/releases.atom

# Asset download base URL (default: https://github.com/bvboe/b2s-go/releases/download)
# Base URL for downloading release assets
# Assets are downloaded from: {base_url}/{version}/{filename}
update_asset_base_url=https://github.com/bvboe/b2s-go/releases/download

# Verify signatures before installing (default: false)
# TODO: Enable when cosign verification is implemented
update_verify_signatures=false

# Enable automatic rollback on failure (default: true)
# If health check fails after update, automatically rollback to previous version
update_rollback_enabled=true

# Health check timeout after update (default: 60s)
# Format: Go duration string or integer seconds
update_health_check_timeout=60s

# Cosign identity regexp for signature verification
update_cosign_identity_regexp=https://github.com/bvboe/b2s-go/*

# Cosign OIDC issuer for signature verification
update_cosign_oidc_issuer=https://token.actions.githubusercontent.com

# Maximum download retry attempts (default: 3)
# Number of times to retry downloading release assets on failure
# Uses exponential backoff: 2s, 4s, 8s, up to 30s max
update_download_max_retries=3

# Validate asset availability before download (default: true)
# When enabled, performs HEAD request to check assets exist before downloading
# Provides faster failure detection and clearer error messages
# Helps avoid partial downloads during incomplete releases
update_download_validate_assets=true

# ============================================================================
# SCHEDULED JOBS CONFIGURATION
# ============================================================================

# Enable scheduled jobs system (default: true)
# When disabled, all jobs below will be inactive
jobs_enabled=true

# --- Refresh Images Job ---
# Periodically reconciles running containers with the database
# This ensures the database stays synchronized with actual workloads

# Enable refresh images job (default: true)
jobs_refresh_images_enabled=true

# How often to run the refresh job (default: 6h)
# Format: Go duration string (e.g., "6h", "12h", "24h")
jobs_refresh_images_interval=6h

# Maximum execution time for refresh job (default: 10m)
jobs_refresh_images_timeout=10m

# --- Cleanup Job ---
# Removes orphaned container images and related data from the database
# Keeps the database lean by cleaning up images no longer in use

# Enable cleanup job (default: true)
jobs_cleanup_enabled=true

# How often to run the cleanup job (default: 24h)
# Format: Go duration string (e.g., "24h", "48h", "7d")
jobs_cleanup_interval=24h

# Maximum execution time for cleanup job (default: 1h)
jobs_cleanup_timeout=1h

# --- Rescan Database Job ---
# Monitors Grype vulnerability database for updates and rescans all images
# This ensures vulnerability data stays current as new CVEs are discovered
# When the database updates, all images are rescanned using their existing SBOMs
# (no need to regenerate SBOMs, only vulnerability scanning is repeated)

# Enable rescan database job (default: true)
jobs_rescan_database_enabled=true

# How often to check for database updates (default: 30m)
# Format: Go duration string (e.g., "30m", "1h", "2h")
# Grype's vulnerability database typically updates daily
jobs_rescan_database_interval=30m

# Maximum execution time for rescan job (default: 30m)
# Should be long enough to scan all images in your environment
jobs_rescan_database_timeout=30m

# --- Future Jobs ---
# Additional scheduled jobs can be configured here as they are implemented
# Examples:
#
# jobs_telemetry_enabled=false
# jobs_telemetry_interval=5m
# jobs_telemetry_jitter=2m
# jobs_telemetry_timeout=30s
