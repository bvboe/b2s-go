name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  packages: read

jobs:
  integration-tests:
    name: Integration Tests
    uses: ./.github/workflows/integration-test.yaml

  # k8s-scan-server component
  k8s-scan-server:
    name: k8s-scan-server
    uses: ./.github/workflows/go-component-reusable.yaml
    with:
      component-name: k8s-scan-server
      component-path: k8s-scan-server
      image-name: k8s-scan-server
      run-tests: true
      run-lint: true
      run-build: true
      run-docker: true
      docker-push: false
      image-tag: test

  # pod-scanner component
  pod-scanner:
    name: pod-scanner
    uses: ./.github/workflows/go-component-reusable.yaml
    with:
      component-name: pod-scanner
      component-path: pod-scanner
      image-name: pod-scanner
      run-tests: true
      run-lint: true
      run-build: true
      run-docker: true
      docker-push: false
      image-tag: test

  # bjorn2scan-agent component (binary build)
  bjorn2scan-agent:
    name: bjorn2scan-agent
    uses: ./.github/workflows/go-binary-reusable.yaml
    with:
      component-name: bjorn2scan-agent
      component-path: bjorn2scan-agent
      run-tests: true
      run-lint: true
      platforms: linux/amd64,linux/arm64
      attach-to-release: false

  helm-lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Lint Helm chart
      run: helm lint helm/bjorn2scan

    - name: Template Helm chart
      run: helm template test helm/bjorn2scan --debug
