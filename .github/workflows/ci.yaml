name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  packages: read

jobs:
  # scanner-core library (dependency for other components)
  scanner-core:
    name: scanner-core
    uses: ./.github/workflows/go-library-reusable.yaml
    with:
      component-name: scanner-core
      component-path: scanner-core
      run-tests: true
      run-lint: true

  integration-tests:
    name: Integration Tests
    needs: [scanner-core]
    uses: ./.github/workflows/integration-test.yaml

  # k8s-scan-server component
  k8s-scan-server:
    name: k8s-scan-server
    needs: [scanner-core]
    uses: ./.github/workflows/go-component-reusable.yaml
    with:
      component-name: k8s-scan-server
      component-path: k8s-scan-server
      image-name: k8s-scan-server
      run-tests: true
      run-lint: true
      run-build: true
      run-docker: true
      docker-push: false
      image-tag: test

  # k8s-update-controller component
  k8s-update-controller:
    name: k8s-update-controller
    needs: [scanner-core]
    uses: ./.github/workflows/go-component-reusable.yaml
    with:
      component-name: k8s-update-controller
      component-path: k8s-update-controller
      image-name: k8s-update-controller
      run-tests: true
      run-lint: true
      run-build: true
      run-docker: true
      docker-push: false
      image-tag: test

  # pod-scanner component (independent - no dependencies)
  pod-scanner:
    name: pod-scanner
    uses: ./.github/workflows/go-component-reusable.yaml
    with:
      component-name: pod-scanner
      component-path: pod-scanner
      image-name: pod-scanner
      run-tests: true
      run-lint: true
      run-build: true
      run-docker: true
      docker-push: false
      image-tag: test

  # bjorn2scan-agent component (binary build)
  bjorn2scan-agent:
    name: bjorn2scan-agent
    needs: [scanner-core]
    uses: ./.github/workflows/go-binary-reusable.yaml
    with:
      component-name: bjorn2scan-agent
      component-path: bjorn2scan-agent
      run-tests: true
      run-lint: true
      platforms: linux/amd64,linux/arm64

  web-lint:
    name: Web Linting (HTML/CSS/JS)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: scanner-core/web/package.json

    - name: Install dependencies
      working-directory: scanner-core/web
      run: npm ci

    - name: Lint HTML
      working-directory: scanner-core/web
      run: npm run lint:html

    - name: Lint CSS
      working-directory: scanner-core/web
      run: npm run lint:css

    - name: Lint JavaScript
      working-directory: scanner-core/web
      run: npm run lint:js

  helm-lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Lint Helm chart
      run: helm lint helm/bjorn2scan

    - name: Template Helm chart
      run: helm template test helm/bjorn2scan --debug

    - name: Validate RBAC Permissions in ClusterRole
      run: ./scripts/test-helm-rbac-template
