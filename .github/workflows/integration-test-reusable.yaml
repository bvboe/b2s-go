name: Integration Test (Reusable)

on:
  workflow_call:
    inputs:
      cluster_type:
        description: 'Type of Kubernetes cluster to test on'
        required: true
        type: string

jobs:
  test:
    name: (${{ inputs.cluster_type }})
    runs-on: ubuntu-latest

    steps:
    - name: Free Disk Space
      run: |
        echo "=== Disk space before cleanup ==="
        df -h /
        echo ""
        echo "Cleaning up Docker resources..."
        docker system prune -af --volumes 2>/dev/null || true
        echo ""
        echo "=== Disk space after cleanup ==="
        df -h /

    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache-dependency-path: |
          k8s-scan-server/go.sum
          pod-scanner/go.sum
          k8s-update-controller/go.sum
          scanner-core/go.sum

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Cache for Kind binary and cluster images
    - name: Cache Kind
      if: inputs.cluster_type == 'kind'
      uses: actions/cache@v5
      with:
        path: |
          ~/.kind
          /var/lib/docker/image
        key: ${{ runner.os }}-kind-${{ hashFiles('.github/workflows/integration-test-reusable.yaml') }}
        restore-keys: |
          ${{ runner.os }}-kind-

    # Cache for Minikube binary and cluster data
    - name: Cache Minikube
      if: inputs.cluster_type == 'minikube'
      uses: actions/cache@v5
      with:
        path: |
          ~/.minikube
          /var/lib/minikube
        key: ${{ runner.os }}-minikube-${{ hashFiles('.github/workflows/integration-test-reusable.yaml') }}
        restore-keys: |
          ${{ runner.os }}-minikube-

    # Cache for Helm binary and repositories
    - name: Cache Helm
      uses: actions/cache@v5
      with:
        path: |
          ~/.cache/helm
          ~/.local/share/helm
        key: ${{ runner.os }}-helm-${{ hashFiles('helm/**') }}
        restore-keys: |
          ${{ runner.os }}-helm-

    # Cache for kubectl binary
    - name: Cache kubectl
      uses: actions/cache@v5
      with:
        path: ~/.kube/cache
        key: ${{ runner.os }}-kubectl-cache
        restore-keys: |
          ${{ runner.os }}-kubectl-

    - name: Build k8s-scan-server image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./k8s-scan-server/Dockerfile
        push: false
        tags: k8s-scan-server:test
        cache-from: |
          type=gha,scope=k8s-scan-server-${{ hashFiles('k8s-scan-server/go.sum', 'scanner-core/go.sum') }}
          type=gha,scope=k8s-scan-server
        cache-to: type=gha,mode=max,scope=k8s-scan-server-${{ hashFiles('k8s-scan-server/go.sum', 'scanner-core/go.sum') }}
        load: true

    - name: Build pod-scanner image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./pod-scanner/Dockerfile
        push: false
        tags: pod-scanner:test
        cache-from: |
          type=gha,scope=pod-scanner-${{ hashFiles('pod-scanner/go.sum', 'scanner-core/go.sum') }}
          type=gha,scope=pod-scanner
        cache-to: type=gha,mode=max,scope=pod-scanner-${{ hashFiles('pod-scanner/go.sum', 'scanner-core/go.sum') }}
        load: true

    - name: Build k8s-update-controller image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./k8s-update-controller/Dockerfile
        push: false
        tags: k8s-update-controller:test
        cache-from: |
          type=gha,scope=k8s-update-controller-${{ hashFiles('k8s-update-controller/go.sum') }}
          type=gha,scope=k8s-update-controller
        cache-to: type=gha,mode=max,scope=k8s-update-controller-${{ hashFiles('k8s-update-controller/go.sum') }}
        load: true

    - name: Set up kind cluster
      if: inputs.cluster_type == 'kind'
      uses: helm/kind-action@v1
      with:
        cluster_name: integration-test

    - name: Load images to kind
      if: inputs.cluster_type == 'kind'
      run: |
        kind load docker-image k8s-scan-server:test --name integration-test
        kind load docker-image pod-scanner:test --name integration-test
        kind load docker-image k8s-update-controller:test --name integration-test

    - name: Set up minikube cluster
      if: inputs.cluster_type == 'minikube'
      uses: medyagh/setup-minikube@latest
      with:
        driver: docker

    - name: Load images to minikube
      if: inputs.cluster_type == 'minikube'
      run: |
        minikube image load k8s-scan-server:test
        minikube image load pod-scanner:test
        minikube image load k8s-update-controller:test

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Deploy with Helm
      run: |
        helm install bjorn2scan ./helm/bjorn2scan \
          --namespace default \
          --create-namespace \
          --set scanServer.image.repository=k8s-scan-server \
          --set scanServer.image.tag=test \
          --set podScanner.image.repository=pod-scanner \
          --set podScanner.image.tag=test \
          --set updateController.enabled=true \
          --set updateController.image.repository=k8s-update-controller \
          --set updateController.image.tag=test \
          --wait \
          --timeout 2m

    - name: Verify deployment
      run: |
        kubectl get pods -n default
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=bjorn2scan -n default --timeout=120s

        # Verify update controller CronJob was created
        kubectl get cronjob -n default
        CRONJOB_COUNT=$(kubectl get cronjob -n default -l app.kubernetes.io/component=update-controller -o name | wc -l)
        if [ "$CRONJOB_COUNT" -eq "0" ]; then
          echo "ERROR: Update controller CronJob not found!"
          exit 1
        fi
        echo "âœ“ Update controller CronJob created successfully"

    - name: Test Helm Upgrade with RBAC Permissions
      run: ./scripts/test-helm-upgrade-rbac
      env:
        TEST_NAMESPACE: default
        RELEASE_NAME: bjorn2scan
        SERVICE_ACCOUNT: bjorn2scan

    - name: Port forward service
      run: |
        kubectl port-forward -n default svc/bjorn2scan 8080:80 &
        sleep 5
        curl -f http://localhost:8080/health || exit 1

    - name: Run integration tests
      working-directory: k8s-scan-server/test/integration
      env:
        SERVICE_URL: http://localhost:8080
      run: go test -v -timeout 5m ./...

    - name: Get pod logs on failure
      if: failure()
      run: |
        echo "=== Pod Status ==="
        kubectl get pods -n default
        echo "=== Pod Logs ==="
        kubectl logs -l app.kubernetes.io/name=bjorn2scan -n default --tail=100

    - name: Cleanup
      if: always()
      run: helm uninstall bjorn2scan -n default || true

    - name: Report Cache Statistics
      if: always()
      run: |
        echo "=== Cache Statistics Report ==="
        echo "Cluster Type: ${{ inputs.cluster_type }}"
        echo ""
        echo "Cache Directories:"

        # Check Kind cache
        if [ -d ~/.kind ]; then
          KIND_SIZE=$(du -sh ~/.kind 2>/dev/null | cut -f1 || echo "0")
          echo "  Kind cache: $KIND_SIZE"
        fi

        # Check Minikube cache
        if [ -d ~/.minikube ]; then
          MINIKUBE_SIZE=$(du -sh ~/.minikube 2>/dev/null | cut -f1 || echo "0")
          echo "  Minikube cache: $MINIKUBE_SIZE"
        fi

        # Check Helm cache
        if [ -d ~/.cache/helm ]; then
          HELM_SIZE=$(du -sh ~/.cache/helm 2>/dev/null | cut -f1 || echo "0")
          echo "  Helm cache: $HELM_SIZE"
        fi

        # Check kubectl cache
        if [ -d ~/.kube/cache ]; then
          KUBECTL_SIZE=$(du -sh ~/.kube/cache 2>/dev/null | cut -f1 || echo "0")
          echo "  kubectl cache: $KUBECTL_SIZE"
        fi

        # Check Go cache
        if [ -d ~/.cache/go-build ]; then
          GO_SIZE=$(du -sh ~/.cache/go-build 2>/dev/null | cut -f1 || echo "0")
          echo "  Go build cache: $GO_SIZE"
        fi

        echo ""
        echo "Total workflow duration: ${{ github.event.workflow_run.run_duration_ms || 'N/A' }}ms"
