name: Integration Test (Reusable)

on:
  workflow_call:
    inputs:
      cluster_type:
        description: 'Type of Kubernetes cluster to test on'
        required: true
        type: string

jobs:
  test:
    name: (${{ inputs.cluster_type }})
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build k8s-scan-server image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./k8s-scan-server/Dockerfile
        push: false
        tags: k8s-scan-server:test
        cache-from: type=gha,scope=k8s-scan-server
        cache-to: type=gha,mode=max,scope=k8s-scan-server
        load: true

    - name: Build pod-scanner image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./pod-scanner/Dockerfile
        push: false
        tags: pod-scanner:test
        cache-from: type=gha,scope=pod-scanner
        cache-to: type=gha,mode=max,scope=pod-scanner
        load: true

    - name: Set up kind cluster
      if: inputs.cluster_type == 'kind'
      uses: helm/kind-action@v1
      with:
        cluster_name: integration-test

    - name: Load images to kind
      if: inputs.cluster_type == 'kind'
      run: |
        kind load docker-image k8s-scan-server:test --name integration-test
        kind load docker-image pod-scanner:test --name integration-test

    - name: Set up minikube cluster
      if: inputs.cluster_type == 'minikube'
      uses: medyagh/setup-minikube@latest
      with:
        driver: docker

    - name: Load images to minikube
      if: inputs.cluster_type == 'minikube'
      run: |
        minikube image load k8s-scan-server:test
        minikube image load pod-scanner:test

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Deploy with Helm
      run: |
        helm install bjorn2scan ./helm/bjorn2scan \
          --namespace default \
          --create-namespace \
          --set scanServer.image.repository=k8s-scan-server \
          --set scanServer.image.tag=test \
          --set podScanner.image.repository=pod-scanner \
          --set podScanner.image.tag=test \
          --wait \
          --timeout 2m

    - name: Verify deployment
      run: |
        kubectl get pods -n default
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=bjorn2scan -n default --timeout=120s

    - name: Port forward service
      run: |
        kubectl port-forward -n default svc/bjorn2scan 8080:80 &
        sleep 5
        curl -f http://localhost:8080/health || exit 1

    - name: Run integration tests
      working-directory: k8s-scan-server/test/integration
      env:
        SERVICE_URL: http://localhost:8080
      run: go test -v -timeout 5m ./...

    - name: Get pod logs on failure
      if: failure()
      run: |
        echo "=== Pod Status ==="
        kubectl get pods -n default
        echo "=== Pod Logs ==="
        kubectl logs -l app.kubernetes.io/name=bjorn2scan -n default --tail=100

    - name: Cleanup
      if: always()
      run: helm uninstall bjorn2scan -n default || true
