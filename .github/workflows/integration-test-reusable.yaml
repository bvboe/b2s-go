name: Integration Test (Reusable)

on:
  workflow_call:
    inputs:
      cluster_type:
        description: 'Type of Kubernetes cluster to test on'
        required: true
        type: string

jobs:
  test:
#    name: (${{ inputs.cluster_type }})
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: ./k8s-scan-server
        push: false
        tags: k8s-scan-server:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true

    - name: Set up kind cluster
      if: inputs.cluster_type == 'kind'
      uses: helm/kind-action@v1
      with:
        cluster_name: integration-test

    - name: Load image to kind
      if: inputs.cluster_type == 'kind'
      run: kind load docker-image k8s-scan-server:test --name integration-test

    - name: Set up minikube cluster
      if: inputs.cluster_type == 'minikube'
      uses: medyagh/setup-minikube@latest
      with:
        driver: docker

    - name: Load image to minikube
      if: inputs.cluster_type == 'minikube'
      run: minikube image load k8s-scan-server:test

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Deploy with Helm
      run: |
        helm install bjorn2scan ./k8s-scan-server/helm/bjorn2scan \
          --namespace default \
          --create-namespace \
          --set image.repository=k8s-scan-server \
          --set image.tag=test \
          --wait \
          --timeout 2m

    - name: Verify deployment
      run: |
        kubectl get pods -n default
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=bjorn2scan -n default --timeout=120s

    - name: Port forward service
      run: |
        kubectl port-forward -n default svc/bjorn2scan 8080:8080 &
        sleep 5
        curl -f http://localhost:8080/health || exit 1

    - name: Run integration tests
      working-directory: k8s-scan-server/test/integration
      env:
        SERVICE_URL: http://localhost:8080
      run: go test -v -timeout 5m ./...

    - name: Get pod logs on failure
      if: failure()
      run: |
        echo "=== Pod Status ==="
        kubectl get pods -n default
        echo "=== Pod Logs ==="
        kubectl logs -l app.kubernetes.io/name=bjorn2scan -n default --tail=100

    - name: Cleanup
      if: always()
      run: helm uninstall bjorn2scan -n default || true
