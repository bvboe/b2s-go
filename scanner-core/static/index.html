<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bjorn2scan - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="multi-select-styles.css">
    <link rel="stylesheet" href="custom-styles.css">
</head>
<body>
    <table width="100%">
        <tr>
            <td valign="top">
                <table id="headerTable">
                    <thead></thead>
                    <tbody id="sidebarNav">
                        <!-- Sidebar navigation will be populated here -->
                    </tbody>
                </table>
            </td>
            <td width="100%" valign="top">
                <h1><div id="clusterName">bjorn2scan</div></h1>

                <!-- Scan Status Widget -->
                <div id="containerScanStatus">
                    <h3>Container Scan Status</h3>
                    <table id="containerScanStatusTable" class="listingTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <br/>

                <!-- Namespace Summary Section -->
                <div id="namespaceSummary">
                    <h3>Namespace Summary</h3>
                    <div style="text-align: right; text-decoration: underline;">
                        <b><a href="" id="namespaceCSVLink">Export to CSV</a></b>
                    </div>

                    <table id="namespaceTable" width="100%" class="listingTable">
                        <thead>
                            <tr>
                                <th rowspan="2" class="sortable" data-sort-field="namespace" onclick="sortNamespaceTable('namespace')"><b>Namespace</b></th>
                                <th rowspan="2" class="sortable" data-sort-field="instance_count" onclick="sortNamespaceTable('instance_count')"><b># Instances</b></th>
                                <th colspan="6"><b>Avg Vulnerabilities per Container</b></th>
                                <th rowspan="2" class="sortable" data-sort-field="avg_risk" onclick="sortNamespaceTable('avg_risk')"><b>Avg Risk Score</b></th>
                                <th rowspan="2" class="sortable" data-sort-field="avg_exploits" onclick="sortNamespaceTable('avg_exploits')"><b>Avg Exploits</b></th>
                                <th rowspan="2" class="sortable" data-sort-field="avg_packages" onclick="sortNamespaceTable('avg_packages')"><b>Avg Packages</b></th>
                            </tr>
                            <tr>
                                <th class="sortable" data-sort-field="avg_critical" onclick="sortNamespaceTable('avg_critical')"><b>Critical</b></th>
                                <th class="sortable" data-sort-field="avg_high" onclick="sortNamespaceTable('avg_high')"><b>High</b></th>
                                <th class="sortable" data-sort-field="avg_medium" onclick="sortNamespaceTable('avg_medium')"><b>Medium</b></th>
                                <th class="sortable" data-sort-field="avg_low" onclick="sortNamespaceTable('avg_low')"><b>Low</b></th>
                                <th class="sortable" data-sort-field="avg_negligible" onclick="sortNamespaceTable('avg_negligible')"><b>Negligible</b></th>
                                <th class="sortable" data-sort-field="avg_unknown" onclick="sortNamespaceTable('avg_unknown')"><b>Unknown</b></th>
                            </tr>
                        </thead>
                        <tbody id="namespaceTableBody"></tbody>
                    </table>

                    <div id="namespacePagination" style="margin: 20px 0; text-align: center;">
                        <!-- Pagination controls will be inserted here -->
                    </div>
                    <br/>
                </div>

                <!-- Distribution Summary Section -->
                <div id="distroSummary">
                    <h3>Container Distribution Summary</h3>
                    <div style="text-align: right; text-decoration: underline;">
                        <b><a href="" id="distributionCSVLink">Export to CSV</a></b>
                    </div>

                    <table id="distributionTable" width="100%" class="listingTable">
                        <thead>
                            <tr>
                                <th rowspan="2" class="sortable" data-sort-field="os_name" onclick="sortDistributionTable('os_name')"><b>OS Distribution</b></th>
                                <th rowspan="2" class="sortable" data-sort-field="instance_count" onclick="sortDistributionTable('instance_count')"><b># Instances</b></th>
                                <th colspan="6"><b>Avg Vulnerabilities per Container</b></th>
                                <th rowspan="2" class="sortable" data-sort-field="avg_risk" onclick="sortDistributionTable('avg_risk')"><b>Avg Risk Score</b></th>
                                <th rowspan="2" class="sortable" data-sort-field="avg_exploits" onclick="sortDistributionTable('avg_exploits')"><b>Avg Exploits</b></th>
                                <th rowspan="2" class="sortable" data-sort-field="avg_packages" onclick="sortDistributionTable('avg_packages')"><b>Avg Packages</b></th>
                            </tr>
                            <tr>
                                <th class="sortable" data-sort-field="avg_critical" onclick="sortDistributionTable('avg_critical')"><b>Critical</b></th>
                                <th class="sortable" data-sort-field="avg_high" onclick="sortDistributionTable('avg_high')"><b>High</b></th>
                                <th class="sortable" data-sort-field="avg_medium" onclick="sortDistributionTable('avg_medium')"><b>Medium</b></th>
                                <th class="sortable" data-sort-field="avg_low" onclick="sortDistributionTable('avg_low')"><b>Low</b></th>
                                <th class="sortable" data-sort-field="avg_negligible" onclick="sortDistributionTable('avg_negligible')"><b>Negligible</b></th>
                                <th class="sortable" data-sort-field="avg_unknown" onclick="sortDistributionTable('avg_unknown')"><b>Unknown</b></th>
                            </tr>
                        </thead>
                        <tbody id="distributionTableBody"></tbody>
                    </table>

                    <div id="distributionPagination" style="margin: 20px 0; text-align: center;">
                        <!-- Pagination controls will be inserted here -->
                    </div>
                </div>

                <div id="app-footer"></div>
            </td>
        </tr>
    </table>

    <script src="shared.js"></script>
    <script>
        // Page-specific state
        const pageTitle = 'Vulnerability Summary';

        // State for each table
        let namespaceTableState = {
            page: 1,
            sortBy: 'namespace',
            sortOrder: 'ASC',
            totalPages: 1,
            totalItems: 0,
            pageSize: 100
        };

        let distributionTableState = {
            page: 1,
            sortBy: 'os_name',
            sortOrder: 'ASC',
            totalPages: 1,
            totalItems: 0,
            pageSize: 100
        };

        // Load all data on page init
        async function initPage() {
            try {
                // Load config and setup navigation
                await loadConfig();

                // Set page title manually
                const clusterNameDiv = document.getElementById('clusterName');
                if (clusterNameDiv && appConfig) {
                    clusterNameDiv.textContent = pageTitle + ' - ' + appConfig.clusterName;
                    document.title = pageTitle + ' - ' + appConfig.clusterName;
                }

                pageConfig.currentPageUrl = 'index.html';
                renderSidebarNav();
                renderVersionFooter();

                // Load all widgets
                await Promise.all([
                    loadScanStatusWidget(),
                    loadNamespaceTable(),
                    loadDistributionTable()
                ]);
            } catch (error) {
                console.error('Error initializing page:', error);
            }
        }

        // Load scan status widget
        async function loadScanStatusWidget() {
            const tableBody = document.querySelector('#containerScanStatusTable tbody');

            try {
                const params = buildQueryParams();
                const response = await fetch(`/api/summary/scan-status${params}`);
                if (!response.ok) throw new Error('Failed to load scan status');

                const data = await response.json();
                tableBody.innerHTML = '';

                const statusCounts = data.statusCounts || [];
                statusCounts.forEach(status => {
                    if (status.count > 0) {
                        const row = document.createElement('tr');
                        const statusCell = document.createElement('td');
                        statusCell.innerHTML = '<b>' + escapeHtml(status.description) + '</b>';
                        row.appendChild(statusCell);

                        const countCell = document.createElement('td');
                        countCell.innerHTML = formatNumber(status.count);
                        countCell.style.textAlign = 'right';
                        row.appendChild(countCell);

                        tableBody.appendChild(row);
                    }
                });

                if (statusCounts.length === 0 || statusCounts.every(s => s.count === 0)) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.innerHTML = 'No scan data available';
                    cell.colSpan = 2;
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading scan status:', error);
                tableBody.innerHTML = '';
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.innerHTML = '⚠️ Error loading data: ' + error.message;
                cell.colSpan = 2;
                cell.style.color = 'red';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        }

        // Load namespace table
        async function loadNamespaceTable() {
            try {
                const params = buildQueryParams({
                    page: namespaceTableState.page,
                    sortBy: namespaceTableState.sortBy,
                    sortOrder: namespaceTableState.sortOrder,
                    pageSize: 100
                });

                const response = await fetch(`/api/summary/by-namespace${params}`);
                if (!response.ok) throw new Error('Failed to load namespace summary');

                const data = await response.json();
                namespaceTableState.totalPages = data.totalPages || 1;
                namespaceTableState.totalItems = data.totalCount || 0;

                renderNamespaceTable(data.namespaces || []);
                renderNamespacePagination();
                updateNamespaceCSVLink(params);
            } catch (error) {
                console.error('Error loading namespace summary:', error);
                const tbody = document.getElementById('namespaceTableBody');
                tbody.innerHTML = '';
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.innerHTML = '⚠️ Error loading data: ' + error.message;
                cell.colSpan = 11;
                cell.style.color = 'red';
                row.appendChild(cell);
                tbody.appendChild(row);
            }
        }

        // Render namespace table
        function renderNamespaceTable(namespaces) {
            const tbody = document.getElementById('namespaceTableBody');
            tbody.innerHTML = '';

            if (namespaces.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.innerHTML = 'No data available';
                cell.colSpan = 11;
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }

            namespaces.forEach(ns => {
                const row = document.createElement('tr');
                row.classList.add('clickable-row');
                row.onclick = function() {
                    window.location.href = 'pods.html?namespaces=' + encodeURIComponent(ns.namespace);
                };

                addCellToRow(row, 'left', ns.namespace || '');
                addCellToRow(row, 'right', formatNumber(ns.instance_count));
                addCellToRow(row, 'right', formatAverage(ns.avg_critical));
                addCellToRow(row, 'right', formatAverage(ns.avg_high));
                addCellToRow(row, 'right', formatAverage(ns.avg_medium));
                addCellToRow(row, 'right', formatAverage(ns.avg_low));
                addCellToRow(row, 'right', formatAverage(ns.avg_negligible));
                addCellToRow(row, 'right', formatAverage(ns.avg_unknown));
                addCellToRow(row, 'right', formatRiskNumber(ns.avg_risk));
                addCellToRow(row, 'right', formatAverage(ns.avg_exploits));
                addCellToRow(row, 'right', formatAverage(ns.avg_packages));

                tbody.appendChild(row);
            });
        }

        // Render namespace pagination
        function renderNamespacePagination() {
            const container = document.getElementById('namespacePagination');
            if (!container) return;

            if (namespaceTableState.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">';
            html += `<button onclick="goToNamespacePage(${namespaceTableState.page - 1})" ${namespaceTableState.page === 1 ? 'disabled' : ''}>Previous</button>`;
            html += '<div style="display: flex; gap: 5px;">';

            for (let i = Math.max(1, namespaceTableState.page - 2); i <= Math.min(namespaceTableState.totalPages, namespaceTableState.page + 2); i++) {
                if (i === namespaceTableState.page) {
                    html += `<button style="font-weight: bold; background: lightgrey;">${i}</button>`;
                } else {
                    html += `<button onclick="goToNamespacePage(${i})">${i}</button>`;
                }
            }

            html += '</div>';
            html += `<button onclick="goToNamespacePage(${namespaceTableState.page + 1})" ${namespaceTableState.page === namespaceTableState.totalPages ? 'disabled' : ''}>Next</button>`;

            const startItem = (namespaceTableState.page - 1) * namespaceTableState.pageSize + 1;
            const endItem = Math.min(namespaceTableState.page * namespaceTableState.pageSize, namespaceTableState.totalItems);
            html += `<span style="margin-left: 20px; color: #666;">Showing ${startItem}-${endItem} of ${namespaceTableState.totalItems}</span>`;

            html += '</div>';
            container.innerHTML = html;
        }

        function goToNamespacePage(page) {
            if (page < 1 || page > namespaceTableState.totalPages) return;
            namespaceTableState.page = page;
            loadNamespaceTable();
        }

        // Update namespace CSV link
        function updateNamespaceCSVLink(params) {
            const link = document.getElementById('namespaceCSVLink');
            link.href = `/api/summary/by-namespace${params}&format=csv`;
        }

        // Sort namespace table
        function sortNamespaceTable(column) {
            if (namespaceTableState.sortBy === column) {
                namespaceTableState.sortOrder = namespaceTableState.sortOrder === 'ASC' ? 'DESC' : 'ASC';
            } else {
                namespaceTableState.sortBy = column;
                namespaceTableState.sortOrder = 'DESC';
            }
            namespaceTableState.page = 1;
            updateNamespaceTableSortIndicators();
            loadNamespaceTable();
        }

        function updateNamespaceTableSortIndicators() {
            const table = document.getElementById('namespaceTable');
            const headers = table.querySelectorAll('th.sortable');

            headers.forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.getAttribute('data-sort-field') === namespaceTableState.sortBy) {
                    th.classList.add(namespaceTableState.sortOrder === 'ASC' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        // Load distribution table
        async function loadDistributionTable() {
            try {
                const params = buildQueryParams({
                    page: distributionTableState.page,
                    sortBy: distributionTableState.sortBy,
                    sortOrder: distributionTableState.sortOrder,
                    pageSize: 100
                });

                const response = await fetch(`/api/summary/by-distribution${params}`);
                if (!response.ok) throw new Error('Failed to load distribution summary');

                const data = await response.json();
                distributionTableState.totalPages = data.totalPages || 1;
                distributionTableState.totalItems = data.totalCount || 0;

                renderDistributionTable(data.distributions || []);
                renderDistributionPagination();
                updateDistributionCSVLink(params);
            } catch (error) {
                console.error('Error loading distribution summary:', error);
                const tbody = document.getElementById('distributionTableBody');
                tbody.innerHTML = '';
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.innerHTML = '⚠️ Error loading data: ' + error.message;
                cell.colSpan = 11;
                cell.style.color = 'red';
                row.appendChild(cell);
                tbody.appendChild(row);
            }
        }

        // Render distribution table
        function renderDistributionTable(distributions) {
            const tbody = document.getElementById('distributionTableBody');
            tbody.innerHTML = '';

            if (distributions.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.innerHTML = 'No data available';
                cell.colSpan = 11;
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }

            distributions.forEach(dist => {
                const row = document.createElement('tr');

                addCellToRow(row, 'left', dist.os_name || '');
                addCellToRow(row, 'right', formatNumber(dist.instance_count));
                addCellToRow(row, 'right', formatAverage(dist.avg_critical));
                addCellToRow(row, 'right', formatAverage(dist.avg_high));
                addCellToRow(row, 'right', formatAverage(dist.avg_medium));
                addCellToRow(row, 'right', formatAverage(dist.avg_low));
                addCellToRow(row, 'right', formatAverage(dist.avg_negligible));
                addCellToRow(row, 'right', formatAverage(dist.avg_unknown));
                addCellToRow(row, 'right', formatRiskNumber(dist.avg_risk));
                addCellToRow(row, 'right', formatAverage(dist.avg_exploits));
                addCellToRow(row, 'right', formatAverage(dist.avg_packages));

                tbody.appendChild(row);
            });
        }

        // Render distribution pagination
        function renderDistributionPagination() {
            const container = document.getElementById('distributionPagination');
            if (!container) return;

            if (distributionTableState.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">';
            html += `<button onclick="goToDistributionPage(${distributionTableState.page - 1})" ${distributionTableState.page === 1 ? 'disabled' : ''}>Previous</button>`;
            html += '<div style="display: flex; gap: 5px;">';

            for (let i = Math.max(1, distributionTableState.page - 2); i <= Math.min(distributionTableState.totalPages, distributionTableState.page + 2); i++) {
                if (i === distributionTableState.page) {
                    html += `<button style="font-weight: bold; background: lightgrey;">${i}</button>`;
                } else {
                    html += `<button onclick="goToDistributionPage(${i})">${i}</button>`;
                }
            }

            html += '</div>';
            html += `<button onclick="goToDistributionPage(${distributionTableState.page + 1})" ${distributionTableState.page === distributionTableState.totalPages ? 'disabled' : ''}>Next</button>`;

            const startItem = (distributionTableState.page - 1) * distributionTableState.pageSize + 1;
            const endItem = Math.min(distributionTableState.page * distributionTableState.pageSize, distributionTableState.totalItems);
            html += `<span style="margin-left: 20px; color: #666;">Showing ${startItem}-${endItem} of ${distributionTableState.totalItems}</span>`;

            html += '</div>';
            container.innerHTML = html;
        }

        function goToDistributionPage(page) {
            if (page < 1 || page > distributionTableState.totalPages) return;
            distributionTableState.page = page;
            loadDistributionTable();
        }

        // Update distribution CSV link
        function updateDistributionCSVLink(params) {
            const link = document.getElementById('distributionCSVLink');
            link.href = `/api/summary/by-distribution${params}&format=csv`;
        }

        // Sort distribution table
        function sortDistributionTable(column) {
            if (distributionTableState.sortBy === column) {
                distributionTableState.sortOrder = distributionTableState.sortOrder === 'ASC' ? 'DESC' : 'ASC';
            } else {
                distributionTableState.sortBy = column;
                distributionTableState.sortOrder = 'DESC';
            }
            distributionTableState.page = 1;
            updateDistributionTableSortIndicators();
            loadDistributionTable();
        }

        function updateDistributionTableSortIndicators() {
            const table = document.getElementById('distributionTable');
            const headers = table.querySelectorAll('th.sortable');

            headers.forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.getAttribute('data-sort-field') === distributionTableState.sortBy) {
                    th.classList.add(distributionTableState.sortOrder === 'ASC' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        // Build query parameters
        function buildQueryParams(additionalParams = {}) {
            const params = new URLSearchParams();

            // Add additional params
            Object.entries(additionalParams).forEach(([key, value]) => {
                if (value !== null && value !== undefined && value !== '') {
                    params.append(key, value);
                }
            });

            const paramString = params.toString();
            return paramString ? '?' + paramString : '';
        }

        // Format average numbers
        function formatAverage(value) {
            if (value === null || value === undefined) return '0.0';
            return value.toFixed(1);
        }

        // Auto-refresh functionality
        let indexCurrentTimestamp = null;

        async function checkForUpdates() {
            try {
                const response = await fetch("/api/lastupdated");
                if (!response.ok) {
                    console.error("Failed to fetch last updated timestamp");
                    return;
                }

                const newTimestamp = await response.text();

                if (indexCurrentTimestamp === null) {
                    // First time - just store the timestamp
                    indexCurrentTimestamp = newTimestamp;
                } else if (newTimestamp !== indexCurrentTimestamp) {
                    // Timestamp changed - reload data
                    console.log("Data updated, reloading...");
                    indexCurrentTimestamp = newTimestamp;
                    // Reload all tables
                    await Promise.all([
                        loadScanStatusWidget(),
                        loadNamespaceTable(),
                        loadDistributionTable()
                    ]);
                }
            } catch (error) {
                console.error("Error checking for updates:", error);
            }
        }

        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            await initPage();
            // Start polling for updates every 2 seconds
            setInterval(checkForUpdates, 2000);
        });
    </script>
</body>
</html>
