<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bjorn2scan - Container Images</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="multi-select-styles.css">
    <style>
        /* Custom multi-select dropdown */
        .custom-multiselect {
            position: relative;
            min-width: 120px;
            max-width: 180px;
        }

        .multiselect-header {
            border: 1px solid #ccc;
            background: white;
            padding: 2px 25px 2px 6px;
            cursor: pointer;
            font-size: 12px;
            min-height: 22px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 2px;
            position: relative;
        }

        .multiselect-header:hover {
            border-color: #999;
        }

        .multiselect-placeholder {
            color: #999;
            font-size: 12px;
        }

        .multiselect-arrow {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid #666;
            pointer-events: none;
        }

        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .multiselect-dropdown.open {
            display: block;
        }

        .multiselect-option {
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .multiselect-option:hover {
            background: #f0f0f0;
        }

        .multiselect-option input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .multiselect-tag {
            background: lightgrey;
            color: #333;
            padding: 0px 4px;
            font-size: 11px;
            border-radius: 3px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            line-height: 1;
            height: 16px;
        }

        .multiselect-tag-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            line-height: 1;
            color: #666;
        }

        .multiselect-tag-remove:hover {
            color: #ff0000;
        }
        .filterBody form {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
        }
        .filterBody label {
            white-space: nowrap;
            margin-right: 3px;
            font-size: 13px;
        }
        .filterBody select {
            min-width: 120px;
            max-width: 180px;
        }
        .ss-main {
            min-width: 120px;
            max-width: 180px;
        }
    </style>
</head>
<body>
    <table width="100%">
        <tr>
            <td valign="top">
                <table id="headerTable">
                    <thead></thead>
                    <tbody id="sidebarNav">
                        <!-- Sidebar navigation will be populated here -->
                    </tbody>
                </table>
            </td>
            <td width="100%" valign="top">
                <h1><div id="clusterName">bjorn2scan</div></h1>

                <table style="border-collapse: collapse;" width="100%" id="filterTable">
                    <thead>
                        <tr>
                            <td width="1%" style="cursor: pointer" onclick="toggleFilterVisible()" class="filterSelected" id="filterCell">
                                <b><div class="filterContainerSelected" id="filterContainer">Filters</div></b>
                            </td>
                            <td colspan="1"></td>
                        </tr>
                    </thead>
                    <tbody id="filterDetails">
                        <tr height="1px">
                            <td style="border-left: 1px solid black;"/>
                            <td style="border-top: 1px solid black; border-right: 1px solid black;"/>
                        </tr>
                        <tr>
                            <td colspan="2" class="filterBody">
                                <form>
                                    <label for="namespaceFilter"><b>Namespace:</b></label>
                                    <select id="namespaceFilter" name="namespaces" multiple onchange="onFilterChange()">
                                    </select>

                                    <label for="vulnerabilityStatusFilter"><b>Vulnerability Status:</b></label>
                                    <select id="vulnerabilityStatusFilter" name="vulnerabilityStatus" multiple onchange="onFilterChange()">
                                    </select>

                                    <label for="packageTypeFilter"><b>Vulnerable Package Type:</b></label>
                                    <select id="packageTypeFilter" name="packageType" multiple onchange="onFilterChange()">
                                    </select>

                                    <label for="osNameFilter"><b>OS Distribution:</b></label>
                                    <select id="osNameFilter" name="osName" multiple onchange="onFilterChange()">
                                    </select>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div style="text-align: right; text-decoration: underline;">
                    <b><a href="" id="csvlink">Export to CSV</a></b>
                </div>

                <table id="vulnerabilityTable" width="100%" class="listingTable">
                    <thead>
                        <tr>
                            <th rowspan="2" class="sortable" data-sort-field="image" onclick="sortByColumn('image')"><b>Container Image</b></th>
                            <th rowspan="2" class="sortable" data-sort-field="instance_count" onclick="sortByColumn('instance_count')"><b># Instances</b></th>
                            <th colspan="6"><b>Vulnerabilities</b></th>
                            <th rowspan="2" class="sortable" data-sort-field="total_risk" onclick="sortByColumn('total_risk')"><b>Risk Score</b></th>
                            <th rowspan="2" class="sortable" data-sort-field="exploit_count" onclick="sortByColumn('exploit_count')"><b>Known Exploits</b></th>
                            <th rowspan="2" class="sortable" data-sort-field="package_count" onclick="sortByColumn('package_count')"><b># Packages</b></th>
                        </tr>
                        <tr>
                            <th class="sortable" data-sort-field="critical_count" onclick="sortByColumn('critical_count')"><b>Critical</b></th>
                            <th class="sortable" data-sort-field="high_count" onclick="sortByColumn('high_count')"><b>High</b></th>
                            <th class="sortable" data-sort-field="medium_count" onclick="sortByColumn('medium_count')"><b>Medium</b></th>
                            <th class="sortable" data-sort-field="low_count" onclick="sortByColumn('low_count')"><b>Low</b></th>
                            <th class="sortable" data-sort-field="negligible_count" onclick="sortByColumn('negligible_count')"><b>Negligible</b></th>
                            <th class="sortable" data-sort-field="unknown_count" onclick="sortByColumn('unknown_count')"><b>Unknown</b></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div id="pagination" style="margin: 20px 0; text-align: center;">
                    <!-- Pagination controls will be inserted here -->
                </div>

                <div id="app-footer"></div>
            </td>
        </tr>
    </table>

    <script>
        // State management
        let currentPage = 1;
        let pageSize = 50;
        let totalPages = 1;
        let totalItems = 0;
        let sortBy = 'image';
        let sortOrder = 'ASC';
        let filtersVisible = true;
        let multiselectInstances = {}; // Store custom multiselect instances

        // Filter visibility toggle
        function toggleFilterVisible() {
            const filterDetails = document.getElementById('filterDetails');
            const filterCell = document.getElementById('filterCell');
            const filterContainer = document.getElementById('filterContainer');

            if (filtersVisible) {
                filterDetails.style.display = 'none';
                filterCell.className = 'filterUnSelected';
                filterContainer.className = 'filterContainerUnSelected';
            } else {
                filterDetails.style.display = '';
                filterCell.className = 'filterSelected';
                filterContainer.className = 'filterContainerSelected';
            }
            filtersVisible = !filtersVisible;
        }

        // Get selected values from multi-select
        function getSelectedValues(selectId) {
            const instance = multiselectInstances[selectId];
            return instance ? instance.getSelected() : [];
        }

        // Custom MultiSelect class
        class CustomMultiSelect {
            static instances = []; // Track all instances

            constructor(selectElement, placeholder = 'Select options') {
                this.selectElement = selectElement;
                this.selectElement.style.display = 'none';
                this.placeholder = placeholder;
                this.selected = [];
                this.options = Array.from(selectElement.options).map(opt => ({
                    value: opt.value,
                    text: opt.text
                }));

                this.createUI();
                this.attachEvents();
                CustomMultiSelect.instances.push(this); // Add to instances list
            }

            createUI() {
                this.container = document.createElement('div');
                this.container.className = 'custom-multiselect';

                this.header = document.createElement('div');
                this.header.className = 'multiselect-header';

                this.placeholderElement = document.createElement('span');
                this.placeholderElement.className = 'multiselect-placeholder';
                this.placeholderElement.textContent = this.placeholder;
                this.header.appendChild(this.placeholderElement);

                this.arrow = document.createElement('div');
                this.arrow.className = 'multiselect-arrow';
                this.header.appendChild(this.arrow);

                this.dropdown = document.createElement('div');
                this.dropdown.className = 'multiselect-dropdown';

                this.options.forEach(opt => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'multiselect-option';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = opt.value;
                    checkbox.dataset.text = opt.text;

                    const label = document.createElement('span');
                    label.textContent = opt.text;

                    optionDiv.appendChild(checkbox);
                    optionDiv.appendChild(label);
                    this.dropdown.appendChild(optionDiv);
                });

                this.container.appendChild(this.header);
                this.container.appendChild(this.dropdown);
                this.selectElement.parentNode.insertBefore(this.container, this.selectElement);
            }

            attachEvents() {
                this.header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggle();
                });

                this.dropdown.addEventListener('click', (e) => {
                    e.stopPropagation(); // Keep dropdown open when clicking inside
                    if (e.target.type === 'checkbox') {
                        this.handleSelection(e.target);
                    } else if (e.target.closest('.multiselect-option')) {
                        const checkbox = e.target.closest('.multiselect-option').querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        this.handleSelection(checkbox);
                    }
                });

                document.addEventListener('click', () => {
                    this.close();
                });
            }

            toggle() {
                const isOpening = !this.dropdown.classList.contains('open');
                if (isOpening) {
                    // Close all other dropdowns before opening this one
                    CustomMultiSelect.instances.forEach(instance => {
                        if (instance !== this) {
                            instance.close();
                        }
                    });
                }
                this.dropdown.classList.toggle('open');
            }

            close() {
                this.dropdown.classList.remove('open');
            }

            handleSelection(checkbox) {
                const value = checkbox.value;
                const text = checkbox.dataset.text;

                if (checkbox.checked) {
                    if (!this.selected.find(s => s.value === value)) {
                        this.selected.push({ value, text });
                    }
                } else {
                    this.selected = this.selected.filter(s => s.value !== value);
                }

                this.updateHeader();
                onFilterChange();
            }

            updateHeader() {
                this.header.innerHTML = '';

                if (this.selected.length === 0) {
                    this.placeholderElement = document.createElement('span');
                    this.placeholderElement.className = 'multiselect-placeholder';
                    this.placeholderElement.textContent = this.placeholder;
                    this.header.appendChild(this.placeholderElement);
                } else {
                    this.selected.forEach(item => {
                        const tag = document.createElement('span');
                        tag.className = 'multiselect-tag';
                        tag.innerHTML = `${item.text} <span class="multiselect-tag-remove">×</span>`;
                        tag.querySelector('.multiselect-tag-remove').addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.removeItem(item.value);
                        });
                        this.header.appendChild(tag);
                    });
                }

                this.arrow = document.createElement('div');
                this.arrow.className = 'multiselect-arrow';
                this.header.appendChild(this.arrow);
            }

            removeItem(value) {
                this.selected = this.selected.filter(s => s.value !== value);
                const checkbox = this.dropdown.querySelector(`input[value="${value}"]`);
                if (checkbox) checkbox.checked = false;
                this.updateHeader();
                onFilterChange();
            }

            getSelected() {
                return this.selected.map(s => s.value);
            }
        }

        // Build URL with current filters and sort
        function buildQueryParams(includeFormat = false) {
            const params = new URLSearchParams();
            params.append('page', currentPage);
            params.append('pageSize', includeFormat ? 10000 : pageSize); // Use large size for CSV export
            params.append('sortBy', sortBy);
            params.append('sortOrder', sortOrder);

            const namespaces = getSelectedValues('namespaceFilter');
            if (namespaces.length) params.append('namespaces', namespaces.join(','));

            const vulnStatuses = getSelectedValues('vulnerabilityStatusFilter');
            if (vulnStatuses.length) params.append('vulnStatuses', vulnStatuses.join(','));

            const packageTypes = getSelectedValues('packageTypeFilter');
            if (packageTypes.length) params.append('packageTypes', packageTypes.join(','));

            const osNames = getSelectedValues('osNameFilter');
            if (osNames.length) params.append('osNames', osNames.join(','));

            if (includeFormat) {
                params.append('format', 'csv');
            }

            return params;
        }

        // Load filter options
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                if (!response.ok) throw new Error('Failed to load filter options');

                const data = await response.json();

                // Populate namespace filter
                const nsSelect = document.getElementById('namespaceFilter');
                nsSelect.innerHTML = (data.namespaces || []).map(ns =>
                    `<option value="${escapeHtml(ns)}">${escapeHtml(ns)}</option>`
                ).join('');

                // Populate vulnerability status filter
                const vulnSelect = document.getElementById('vulnerabilityStatusFilter');
                vulnSelect.innerHTML = (data.vulnStatuses || []).map(status =>
                    `<option value="${escapeHtml(status)}">${escapeHtml(status)}</option>`
                ).join('');

                // Populate package type filter
                const pkgSelect = document.getElementById('packageTypeFilter');
                pkgSelect.innerHTML = (data.packageTypes || []).map(type =>
                    `<option value="${escapeHtml(type)}">${escapeHtml(type)}</option>`
                ).join('');

                // Populate OS name filter
                const osSelect = document.getElementById('osNameFilter');
                osSelect.innerHTML = (data.osNames || []).map(os =>
                    `<option value="${escapeHtml(os)}">${escapeHtml(os)}</option>`
                ).join('');

                // Initialize custom multi-select on all filter dropdowns
                initializeMultiselects();

            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        // Initialize custom multi-select dropdowns
        function initializeMultiselects() {
            const filters = [
                { id: 'namespaceFilter', placeholder: 'All namespaces' },
                { id: 'vulnerabilityStatusFilter', placeholder: 'All statuses' },
                { id: 'packageTypeFilter', placeholder: 'All package types' },
                { id: 'osNameFilter', placeholder: 'All distributions' }
            ];

            filters.forEach(filter => {
                const element = document.getElementById(filter.id);
                if (element && !multiselectInstances[filter.id]) {
                    multiselectInstances[filter.id] = new CustomMultiSelect(element, filter.placeholder);
                }
            });
        }

        // Add cell to row
        function addCellToRow(row, align, text) {
            const cell = document.createElement('td');
            cell.style.textAlign = align;
            cell.textContent = text;
            row.appendChild(cell);
            return cell;
        }

        // Format number with commas
        function formatNumber(num) {
            if (num === null || num === undefined || num === 0) return '0';
            return num.toLocaleString();
        }

        // Format risk number
        function formatRiskNumber(num) {
            if (num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString();
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Check if scan is complete based on status description
        function isScanComplete(statusDescription) {
            return statusDescription === 'Scan complete';
        }

        // Load images table
        async function loadImagesTable() {
            const tableBody = document.querySelector('#vulnerabilityTable tbody');

            try {
                const params = buildQueryParams(false);
                const response = await fetch(`/api/images?${params}`);

                if (!response.ok) {
                    throw new Error(`Failed to load image data: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                tableBody.innerHTML = '';

                // Update pagination state
                totalPages = data.totalPages || 1;
                totalItems = data.totalCount || 0;
                currentPage = data.page || currentPage;

                (data.images || []).forEach(item => {
                    const row = document.createElement('tr');
                    row.classList.add('clickable-row');
                    // TODO: Add click handler to navigate to image detail page
                    // row.onclick = () => window.location.href = `/image.html?digest=${encodeURIComponent(item.digest)}`;

                    // Add image name
                    addCellToRow(row, 'left', item.image || '');

                    // Add instance count
                    addCellToRow(row, 'right', formatNumber(item.instance_count));

                    // Check if scan is complete
                    if (isScanComplete(item.status_description)) {
                        // Show vulnerability counts
                        addCellToRow(row, 'right', formatNumber(item.critical_count));
                        addCellToRow(row, 'right', formatNumber(item.high_count));
                        addCellToRow(row, 'right', formatNumber(item.medium_count));
                        addCellToRow(row, 'right', formatNumber(item.low_count));
                        addCellToRow(row, 'right', formatNumber(item.negligible_count));
                        addCellToRow(row, 'right', formatNumber(item.unknown_count));
                        addCellToRow(row, 'right', formatRiskNumber(item.total_risk));
                        addCellToRow(row, 'right', formatNumber(item.exploit_count));
                        addCellToRow(row, 'right', formatNumber(item.package_count));
                    } else {
                        // Show status message spanning all vulnerability columns
                        const cell = addCellToRow(row, 'left', item.status_description || 'Unknown status');
                        cell.colSpan = 9;
                    }

                    tableBody.appendChild(row);
                });

                renderPagination();

            } catch (error) {
                console.error('Error loading image data:', error);
                tableBody.innerHTML = '';
                const row = document.createElement('tr');
                const cell = addCellToRow(row, 'left', '⚠️ Error loading data: ' + error.message);
                cell.colSpan = 11;
                cell.style.color = 'red';
                tableBody.appendChild(row);
                renderPagination();
            }
        }

        // Handle filter changes
        function onFilterChange() {
            currentPage = 1; // Reset to first page when filters change
            loadImagesTable();
            updateCSVLink();
        }

        // Pagination functions
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadImagesTable();
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadImagesTable();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadImagesTable();
            }
        }

        function renderPagination() {
            const paginationDiv = document.getElementById('pagination');
            if (!paginationDiv) return;

            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }

            let html = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">';

            // Previous button
            html += `<button onclick="prevPage()" ${currentPage === 1 ? 'disabled' : ''} style="padding: 5px 10px; cursor: ${currentPage === 1 ? 'default' : 'pointer'};">Previous</button>`;

            // Page numbers
            html += '<div style="display: flex; gap: 5px;">';

            // Always show first page
            if (currentPage > 3) {
                html += `<button onclick="goToPage(1)" style="padding: 5px 10px; cursor: pointer;">1</button>`;
                if (currentPage > 4) {
                    html += `<span style="padding: 5px;">...</span>`;
                }
            }

            // Show pages around current page
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                if (i === currentPage) {
                    html += `<button style="padding: 5px 10px; font-weight: bold; background: lightgrey;">${i}</button>`;
                } else {
                    html += `<button onclick="goToPage(${i})" style="padding: 5px 10px; cursor: pointer;">${i}</button>`;
                }
            }

            // Always show last page
            if (currentPage < totalPages - 2) {
                if (currentPage < totalPages - 3) {
                    html += `<span style="padding: 5px;">...</span>`;
                }
                html += `<button onclick="goToPage(${totalPages})" style="padding: 5px 10px; cursor: pointer;">${totalPages}</button>`;
            }

            html += '</div>';

            // Next button
            html += `<button onclick="nextPage()" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 5px 10px; cursor: ${currentPage === totalPages ? 'default' : 'pointer'};">Next</button>`;

            // Page info
            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, totalItems);
            html += `<span style="margin-left: 20px; color: #666;">Showing ${startItem}-${endItem} of ${totalItems}</span>`;

            html += '</div>';

            paginationDiv.innerHTML = html;
        }

        // Update CSV export link
        function updateCSVLink() {
            const params = buildQueryParams(true);
            document.getElementById('csvlink').href = `/api/images?${params}`;
        }

        // Sort by column
        function sortByColumn(column) {
            if (sortBy === column) {
                sortOrder = sortOrder === 'ASC' ? 'DESC' : 'ASC';
            } else {
                sortBy = column;
                sortOrder = 'ASC';
            }
            updateSortIndicators();
            loadImagesTable();
        }

        // Update sort indicators on column headers
        function updateSortIndicators() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sortField === sortBy) {
                    th.classList.add(sortOrder === 'ASC' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Global config storage
        let appConfig = {
            clusterName: 'bjorn2scan',
            version: '1.0.0',
            scanContainers: true,
            scanNodes: false
        };

        // Load configuration from API
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error('Failed to load config');
                }
                const data = await response.json();

                // Update global config with API data
                appConfig.clusterName = data.clusterName || appConfig.clusterName;
                appConfig.version = data.version || appConfig.version;
                appConfig.scanContainers = data.scanContainers !== undefined ? data.scanContainers : appConfig.scanContainers;
                appConfig.scanNodes = data.scanNodes !== undefined ? data.scanNodes : appConfig.scanNodes;

                // Update cluster name in UI
                const clusterNameDiv = document.getElementById('clusterName');
                clusterNameDiv.textContent = 'Image Summary - ' + appConfig.clusterName;

                // Update page title
                document.title = 'Image Summary - ' + appConfig.clusterName;

            } catch (error) {
                console.error('Error loading config:', error);
                // Keep defaults if API fails
            }
        }

        // Render sidebar navigation
        function renderSidebarNav() {
            const tableBody = document.getElementById('sidebarNav');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            const showContainerScans = appConfig.scanContainers;
            const showNodeScans = appConfig.scanNodes;

            const currentPage = 'images.html';

            function addNavItem(title, url) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');

                const isCurrentPage = url === currentPage;
                const decoration = isCurrentPage ? '<u>' : '';
                const decorationEnd = isCurrentPage ? '</u>' : '';

                cell.innerHTML = `<h2><a href="${url}">${decoration}${title}${decorationEnd}</a></h2>`;
                row.appendChild(cell);
                tableBody.appendChild(row);
            }

            addNavItem('Summary', 'index.html');
            if (showContainerScans) {
                addNavItem('Images', 'images.html');
                addNavItem('Pods', 'pods.html');
            }
            if (showNodeScans) {
                addNavItem('Nodes', 'nodes.html');
            }
            if (showContainerScans) {
                addNavItem('CVEs', 'cves.html');
                addNavItem('SBOM', 'sbom.html');
            }
        }

        // Render version footer
        function renderVersionFooter() {
            const footer = document.getElementById('app-footer');
            if (!footer) return;

            footer.innerHTML = `<p style="text-align: right; color: #666; font-style: italic;"><a href="https://github.com/bvboe/b2s-go" target="_blank" style="color: #666; text-decoration: underline;">bjorn2scan v${appConfig.version}</a></p>`;
        }

        // Initialize page
        async function initPage() {
            await loadConfig();
            renderSidebarNav();
            renderVersionFooter();
            await loadFilterOptions();
            loadImagesTable();
            updateCSVLink();
            updateSortIndicators();
        }

        // Load page when DOM is ready
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
