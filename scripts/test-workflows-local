#!/bin/bash
set -e

# Script to test GitHub Actions workflows locally using act
# This helps validate caching improvements before pushing

echo "==================================="
echo "Testing GitHub Actions Locally"
echo "==================================="
echo ""

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if act is installed
if ! command -v act &> /dev/null; then
    echo -e "${YELLOW}Error: act is not installed${NC}"
    echo "Install with: brew install act"
    echo "Or see: https://github.com/nektos/act"
    exit 1
fi

echo -e "${GREEN}✓ act is installed ($(act --version))${NC}"
echo ""

# Test function
test_workflow() {
    local workflow=$1
    local job=$2
    local description=$3

    echo -e "${BLUE}Testing: $description${NC}"
    echo "Workflow: $workflow"
    echo "Job: $job"
    echo ""

    # Run workflow with act (dry-run mode for fast testing)
    if act -W ".github/workflows/$workflow" -j "$job" --dryrun 2>&1; then
        echo -e "${GREEN}✓ $description: Syntax valid${NC}"
        return 0
    else
        echo -e "${YELLOW}✗ $description: Failed${NC}"
        return 1
    fi
}

# Track test results
TESTS_PASSED=0
TESTS_FAILED=0

echo "=== Workflow Syntax Validation ==="
echo ""

# Test integration workflow
if test_workflow "integration-test-reusable.yaml" "test" "Integration Test (Kind)"; then
    ((TESTS_PASSED++))
else
    ((TESTS_FAILED++))
fi
echo ""

# Test go-component workflow
if test_workflow "go-component-reusable.yaml" "test" "Go Component CI (Test)"; then
    ((TESTS_PASSED++))
else
    ((TESTS_FAILED++))
fi
echo ""

if test_workflow "go-component-reusable.yaml" "lint" "Go Component CI (Lint)"; then
    ((TESTS_PASSED++))
else
    ((TESTS_FAILED++))
fi
echo ""

# Test go-library workflow
if test_workflow "go-library-reusable.yaml" "test" "Go Library CI (Test)"; then
    ((TESTS_PASSED++))
else
    ((TESTS_FAILED++))
fi
echo ""

if test_workflow "go-library-reusable.yaml" "lint" "Go Library CI (Lint)"; then
    ((TESTS_PASSED++))
else
    ((TESTS_FAILED++))
fi
echo ""

# Test go-binary workflow
if test_workflow "go-binary-reusable.yaml" "test" "Go Binary Build (Test)"; then
    ((TESTS_PASSED++))
else
    ((TESTS_FAILED++))
fi
echo ""

echo "==================================="
echo "Test Results"
echo "==================================="
echo -e "Passed: ${GREEN}$TESTS_PASSED${NC}"
echo -e "Failed: ${YELLOW}$TESTS_FAILED${NC}"
echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ All workflow syntax tests passed!${NC}"
    echo ""
    echo "=== Next Steps ==="
    echo "1. To run a full integration test (slow):"
    echo "   act -W .github/workflows/integration-test-reusable.yaml -j test"
    echo ""
    echo "2. To test with specific inputs:"
    echo "   act -W .github/workflows/integration-test-reusable.yaml -j test -input cluster_type=kind"
    echo ""
    echo "3. To see workflow jobs:"
    echo "   act -W .github/workflows/ci.yaml -l"
    echo ""
    exit 0
else
    echo -e "${YELLOW}Some tests failed. Please review the errors above.${NC}"
    exit 1
fi
