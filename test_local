#!/usr/bin/env bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEST_NAMESPACE="test-$(date +%s)"
SCAN_SERVER_IMAGE="k8s-scan-server"
POD_SCANNER_IMAGE="pod-scanner"
IMAGE_TAG="local-test"
CLEANUP_ON_EXIT=true

# Track test results
TESTS_PASSED=0
TESTS_FAILED=0

print_header() {
    echo -e "${BLUE}================================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}================================================${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}→ $1${NC}"
}

cleanup() {
    if [ "$CLEANUP_ON_EXIT" = true ]; then
        print_header "Cleaning up"

        # Cleanup kind
        if kind get clusters 2>/dev/null | grep -q "local-test"; then
            print_info "Deleting kind cluster..."
            kind delete cluster --name local-test 2>/dev/null || true
        fi

        # Cleanup minikube namespace
        if kubectl get namespace "$TEST_NAMESPACE" 2>/dev/null; then
            print_info "Deleting test namespace from minikube..."
            kubectl delete namespace "$TEST_NAMESPACE" --ignore-not-found=true 2>/dev/null || true
        fi

        print_success "Cleanup complete"
    fi
}

trap cleanup EXIT

run_test() {
    local test_name=$1
    shift

    print_info "Running: $test_name"

    if "$@"; then
        print_success "$test_name"
        ((TESTS_PASSED++))
        return 0
    else
        print_error "$test_name"
        ((TESTS_FAILED++))
        return 1
    fi
}

print_header "Local Test Suite"
echo "Test namespace: $TEST_NAMESPACE"
echo "Scan Server Image: $SCAN_SERVER_IMAGE:$IMAGE_TAG"
echo "Pod Scanner Image: $POD_SCANNER_IMAGE:$IMAGE_TAG"
echo ""

# 1. Unit Tests
print_header "1. Unit Tests - k8s-scan-server"
cd "$SCRIPT_DIR/k8s-scan-server"
run_test "k8s-scan-server: Go unit tests" go test -v ./...
run_test "k8s-scan-server: Go vet" go vet ./...

print_header "1. Unit Tests - pod-scanner"
cd "$SCRIPT_DIR/pod-scanner"
run_test "pod-scanner: Go unit tests" go test -v ./...
run_test "pod-scanner: Go vet" go vet ./...

# 2. Code Quality
print_header "2. Code Quality - k8s-scan-server"
cd "$SCRIPT_DIR/k8s-scan-server"
if command -v golangci-lint &> /dev/null; then
    run_test "k8s-scan-server: golangci-lint" golangci-lint run ./...
else
    print_error "golangci-lint not installed, skipping"
    ((TESTS_FAILED++))
fi

print_header "2. Code Quality - pod-scanner"
cd "$SCRIPT_DIR/pod-scanner"
if command -v golangci-lint &> /dev/null; then
    run_test "pod-scanner: golangci-lint" golangci-lint run ./...
else
    print_error "golangci-lint not installed, skipping"
    ((TESTS_FAILED++))
fi

# 3. Build
print_header "3. Build Tests - k8s-scan-server"
cd "$SCRIPT_DIR/k8s-scan-server"
run_test "k8s-scan-server: Go build" go build -v -o k8s-scan-server .
cd "$SCRIPT_DIR"
run_test "k8s-scan-server: Docker build" docker build -f k8s-scan-server/Dockerfile -t "$SCAN_SERVER_IMAGE:$IMAGE_TAG" --build-arg VERSION=local-test .

print_header "3. Build Tests - pod-scanner"
cd "$SCRIPT_DIR/pod-scanner"
run_test "pod-scanner: Go build" go build -v -o pod-scanner .
cd "$SCRIPT_DIR"
run_test "pod-scanner: Docker build" docker build -f pod-scanner/Dockerfile -t "$POD_SCANNER_IMAGE:$IMAGE_TAG" --build-arg VERSION=local-test .

# 4. Helm Tests
print_header "4. Helm Tests"
cd "$SCRIPT_DIR"
run_test "Helm lint" helm lint ./helm/bjorn2scan
run_test "Helm template" helm template test ./helm/bjorn2scan --namespace "$TEST_NAMESPACE" > /dev/null

# 5. Integration Tests - kind
print_header "5. Integration Tests - kind"

print_info "Creating kind cluster..."
if kind create cluster --name local-test --wait 5m; then
    print_success "kind cluster created"

    print_info "Loading images to kind..."
    kind load docker-image "$SCAN_SERVER_IMAGE:$IMAGE_TAG" --name local-test
    kind load docker-image "$POD_SCANNER_IMAGE:$IMAGE_TAG" --name local-test

    print_info "Creating namespace..."
    kubectl create namespace "$TEST_NAMESPACE"

    print_info "Installing Helm chart..."
    if helm install bjorn2scan "$SCRIPT_DIR/helm/bjorn2scan" \
        --namespace "$TEST_NAMESPACE" \
        --set scanServer.image.repository="$SCAN_SERVER_IMAGE" \
        --set scanServer.image.tag="$IMAGE_TAG" \
        --set podScanner.image.repository="$POD_SCANNER_IMAGE" \
        --set podScanner.image.tag="$IMAGE_TAG" \
        --wait --timeout 2m; then

        print_success "Helm chart installed on kind"

        print_info "Waiting for pod to be ready..."
        if kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=bjorn2scan \
            -n "$TEST_NAMESPACE" \
            --timeout=120s; then

            print_success "Pod ready on kind"

            # Run integration tests
            print_info "Setting up port-forward to scan-server..."
            kubectl port-forward -n "$TEST_NAMESPACE" svc/scan-server 8080:8080 > /dev/null 2>&1 &
            PF_PID=$!
            sleep 3

            print_info "Running integration tests..."
            cd "$SCRIPT_DIR/k8s-scan-server/test/integration"
            if SERVICE_URL=http://localhost:8080 go test -v -timeout 5m ./...; then
                print_success "Integration tests passed on kind"
                ((TESTS_PASSED++))
            else
                print_error "Integration tests failed on kind"
                ((TESTS_FAILED++))
            fi
            cd "$SCRIPT_DIR"

            # Cleanup port-forward
            kill $PF_PID 2>/dev/null || true
        else
            print_error "Pod failed to become ready on kind"
            kubectl get pods -n "$TEST_NAMESPACE"
            kubectl logs -l app.kubernetes.io/name=bjorn2scan -n "$TEST_NAMESPACE" --tail=50
            ((TESTS_FAILED++))
        fi

        print_info "Uninstalling from kind..."
        helm uninstall bjorn2scan -n "$TEST_NAMESPACE"
    else
        print_error "Failed to install Helm chart on kind"
        ((TESTS_FAILED++))
    fi

    print_info "Deleting kind cluster..."
    kind delete cluster --name local-test
else
    print_error "Failed to create kind cluster"
    ((TESTS_FAILED++))
fi

# 6. Integration Tests - minikube
print_header "6. Integration Tests - minikube"

print_info "Starting minikube (if not running)..."
if minikube start 2>/dev/null || minikube status > /dev/null 2>&1; then
    print_success "minikube running"

    print_info "Loading images to minikube..."
    minikube image load "$SCAN_SERVER_IMAGE:$IMAGE_TAG"
    minikube image load "$POD_SCANNER_IMAGE:$IMAGE_TAG"

    print_info "Creating namespace..."
    kubectl create namespace "$TEST_NAMESPACE" || true

    print_info "Installing Helm chart..."
    if helm install bjorn2scan "$SCRIPT_DIR/helm/bjorn2scan" \
        --namespace "$TEST_NAMESPACE" \
        --set scanServer.image.repository="$SCAN_SERVER_IMAGE" \
        --set scanServer.image.tag="$IMAGE_TAG" \
        --set podScanner.image.repository="$POD_SCANNER_IMAGE" \
        --set podScanner.image.tag="$IMAGE_TAG" \
        --wait --timeout 2m; then

        print_success "Helm chart installed on minikube"

        print_info "Waiting for pod to be ready..."
        if kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=bjorn2scan \
            -n "$TEST_NAMESPACE" \
            --timeout=120s; then

            print_success "Pod ready on minikube"

            # Run integration tests
            print_info "Setting up port-forward to scan-server..."
            kubectl port-forward -n "$TEST_NAMESPACE" svc/scan-server 8080:8080 > /dev/null 2>&1 &
            PF_PID=$!
            sleep 3

            print_info "Running integration tests..."
            cd "$SCRIPT_DIR/k8s-scan-server/test/integration"
            if SERVICE_URL=http://localhost:8080 go test -v -timeout 5m ./...; then
                print_success "Integration tests passed on minikube"
                ((TESTS_PASSED++))
            else
                print_error "Integration tests failed on minikube"
                ((TESTS_FAILED++))
            fi
            cd "$SCRIPT_DIR"

            # Cleanup port-forward
            kill $PF_PID 2>/dev/null || true
        else
            print_error "Pod failed to become ready on minikube"
            kubectl get pods -n "$TEST_NAMESPACE"
            kubectl logs -l app.kubernetes.io/name=bjorn2scan -n "$TEST_NAMESPACE" --tail=50
            ((TESTS_FAILED++))
        fi

        print_info "Uninstalling from minikube..."
        helm uninstall bjorn2scan -n "$TEST_NAMESPACE"
    else
        print_error "Failed to install Helm chart on minikube"
        ((TESTS_FAILED++))
    fi
else
    print_error "Failed to start minikube"
    ((TESTS_FAILED++))
fi

# Summary
print_header "Test Summary"
echo -e "Tests Passed: ${GREEN}$TESTS_PASSED${NC}"
echo -e "Tests Failed: ${RED}$TESTS_FAILED${NC}"
echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    print_success "All tests passed!"
    exit 0
else
    print_error "Some tests failed"
    exit 1
fi
